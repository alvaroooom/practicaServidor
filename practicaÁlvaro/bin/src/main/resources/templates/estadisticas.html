<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{estadisticas.titulo}">Estadísticas - Formación en Empresa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

    <div th:replace="~{componentes/header :: header}"></div>

    <div class="container my-5">
        <div class="col-12" sec:authorize="hasRole('DIRECTIVO')">
            
            <!-- Título -->
            <div class="alert alert-info border-0 shadow-sm d-flex justify-content-between align-items-center py-4 mb-4">
                <div>
                    <h4 class="alert-heading fw-bold mb-1"><i class="bi bi-graph-up"></i> <span th:text="#{estadisticas.header}">Estadísticas</span></h4>
                    <p class="mb-0" th:text="#{estadisticas.descripcion}">Estadísticas de las prácticas de alumnos en las diferentes empresas.</p>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-building"></i> <span th:text="#{estadisticas.alumnosEmpresa}">Alumnos por Empresa</span></h5>
                            <canvas id="chartEmpresas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-mortarboard"></i> <span th:text="#{estadisticas.alumnosCurso}">Alumnos por Curso</span></h5>
                            <canvas id="chartCursos"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen numérico -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 text-center py-3">
                        <div class="card-body">
                            <h6 class="text-muted text-uppercase" th:text="#{estadisticas.empresasParticipantes}">Empresas Participantes</h6>
                            <h2 class="fw-bold text-primary" th:text="${totalEmpresas ?: 0}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 text-center py-3">
                        <div class="card-body">
                            <h6 class="text-muted text-uppercase" th:text="#{estadisticas.alumnosPracticas}">Alumnos en Prácticas</h6>
                            <h2 class="fw-bold text-success" th:text="${alumnosEnPracticas ?: 0}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 text-center py-3">
                        <div class="card-body">
                            <h6 class="text-muted text-uppercase" th:text="#{estadisticas.tasaOcupacion}">Tasa de Ocupación</h6>
                            <h2 class="fw-bold text-info" th:text="|${totalAlumnos > 0 ? ((alumnosEnPracticas * 100) / totalAlumnos) : 0}%|">0%</h2>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <!-- Mensaje si no es directivo -->
        <div class="col-12" sec:authorize="!hasRole('DIRECTIVO')">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> <span th:text="#{estadisticas.accesoDenegado}">Acceso restringido a personal directivo.</span>
            </div>
        </div>
    </div>

    <div th:replace="~{componentes/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        // Preparamos los datos para el archivo JS externo
        const datosGraficas = {
            nombresEmpresas: /*[[${nombresEmpresas}]]*/ [],
            datosEmpresas: /*[[${conteoEmpresas}]]*/ [],
            nombresCursos: /*[[${nombresCursos}]]*/ [],
            datosCursos: /*[[${conteoCursos}]]*/ []
        };
    </script>
    <script th:src="@{/js/estadisticas.js}"></script>
</body>
</html>
